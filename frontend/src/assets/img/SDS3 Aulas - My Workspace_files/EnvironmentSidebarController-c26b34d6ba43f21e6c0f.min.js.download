(window.webpackJsonp=window.webpackJsonp||[]).push([[33],{8453:function(e,t,i){"use strict";i.r(t),function(e){i.d(t,"default",(function(){return c}));var r=i(3497),o=i(3450),s=i(8454),n=i(3285),a=i(4222);class c extends a.default{getListAndSubscribeAPIEndpoint(){throw new Error(this.constructor.name+"~getListAndSubscribeAPIEndpoint: not implemented")}getListAPIEndpoint(){throw new Error(this.constructor.name+"~getListAPIEndpoint: not implemented")}hydrate(t=!0){return new Promise((i,o)=>{this._connection_subscription=Object(r.getSocketConnectionObservable)().subscribe(r=>{if("connect"===r)return this._getAPIResponse().then(i=>{const r=e.get(i,"body.data",[]),o=e.get(i,"body.subscription.id");this._hydrateEntities(r),t&&o&&this._subscribeToChangeEvents(o)}).then(()=>i()).catch(e=>(pm.logger.warn("ListingAPIAdapter~hydrate: Failed to hydrate entities",e),o(e)))})})}dispose(){super.dispose(),this._connection_subscription&&this._connection_subscription.unsubscribe(),this._realtime_subscription&&this._realtime_subscription.unsubscribe()}_hydrateEntities(e){this.model.hydrate&&this.model.hydrate(e)}_removeEntities(t){e.isEmpty(t)||this.model.remove&&this.model.remove(t)}_addEntities(t){e.isEmpty(t)||this.model.add&&this.model.add(t)}async _getAPIResponse(){return await Object(n.getStore)("SyncStatusStore").onSyncAvailable(),o.default.request(this.getListAndSubscribeAPIEndpoint(),{method:"POST",timeout:3e4})}_subscribeToChangeEvents(t){this._realtime_subscription&&this._realtime_subscription.unsubscribe(),this._realtime_subscription=Object(s.realtimeEventsForSubscription)(t).subscribe(t=>{const i=e.get(t,"data.data",[]),r=i.filter(({action:e})=>["create","update"].includes(e)).map(({id:e})=>e),o=i.filter(({action:e})=>"delete"===e).map(({id:e})=>e);this._removeEntities(o),this._createOrUpdateEntities(r)})}async _createOrUpdateEntities(t){if(e.isEmpty(t))return;await Object(n.getStore)("SyncStatusStore").onSyncAvailable();const i=await o.default.request(this.getListAPIEndpoint(),{method:"POST",data:{ids:t},timeout:3e4}),r=e.get(i,"body.data",[]);this._addEntities(r)}}}.call(this,i(1132))},8454:function(e,t,i){"use strict";i.r(t),function(e){i.d(t,"realtimeEventsForSubscription",(function(){return s}));var r=i(3527),o=i(3629);function s(t){return Object(o.getRealtimeMessagesObservable)().pipe(Object(r.filter)(i=>e.get(i,"data.subscription.id")===t))}}.call(this,i(1132))},8472:function(e,t,i){"use strict";i.r(t),function(e){i.d(t,"GlobalsModel",(function(){return j})),i.d(t,"EnvironmentModel",(function(){return T})),i.d(t,"default",(function(){return P}));var r,o,s,n,a,c,d,p,u,l,b=i(1505),h=i(3285),m=i(2941),y=i(3831),O=i(3832),v=i(3300),S=i(3815),E=i(4858),f=i(7438),g=i(3811),A=i(4859);function w(e,t,i,r){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(r):void 0})}function _(e,t,i,r,o){var s={};return Object.keys(r).forEach((function(e){s[e]=r[e]})),s.enumerable=!!s.enumerable,s.configurable=!!s.configurable,("value"in s||s.initializer)&&(s.writable=!0),s=i.slice().reverse().reduce((function(i,r){return r(e,t,i)||i}),s),o&&void 0!==s.initializer&&(s.value=s.initializer?s.initializer.call(o):void 0,s.initializer=void 0),void 0===s.initializer&&(Object.defineProperty(e,t,s),s=null),s}const I=["name","createdAt"];let j=(o=_((r=class{constructor(){w(this,"isActive",o,this),this._disposer=Object(b.autorun)(()=>{const e=Object(h.getStore)("EditorStore").find(Object(h.getStore)("ActiveWorkspaceSessionStore").activeEditor);e&&e.resource&&e.resource.includes(S.GLOBALS)?this.setFocus(!0):this.setFocus(!1)})}dispose(){this._disposer()}setFocus(e){this.isActive=e}openInTab(){Object(E.openGlobalsInTab)()}}).prototype,"isActive",[b.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_(r.prototype,"setFocus",[b.action],Object.getOwnPropertyDescriptor(r.prototype,"setFocus"),r.prototype),r),T=(_((s=class extends f.default{updateName(e){this.update({name:e})}get isActive(){return Object(h.getStore)("ActiveEnvironmentStore").id===Object(v.decomposeUID)(this.id).modelId}}).prototype,"updateName",[b.action],Object.getOwnPropertyDescriptor(s.prototype,"updateName"),s.prototype),_(s.prototype,"isActive",[b.computed],Object.getOwnPropertyDescriptor(s.prototype,"isActive"),s.prototype),s),P=(a=_((n=class{constructor(){w(this,"activeItem",a,this),w(this,"sortBy",c,this),w(this,"searchQuery",d,this),w(this,"$items",p,this),w(this,"isLoading",u,this),w(this,"sharedEnvironments",l,this),this.globals=new j,this._dispose=Object(b.autorun)(()=>{const e=Object(h.getStore)("EditorStore").find(Object(h.getStore)("ActiveWorkspaceSessionStore").activeEditor);if(e)if(e.resource.includes(S.ENVIRONMENT)){const t=e.resource.split("/").pop();this.focusItem(t)}else this.resetFocus();else this.resetFocus()}),this.openEntityInTabDebounced=e.debounce(e=>{m.default.transitionTo("build.environment",{eid:e})},300)}dispose(){this.globals.dispose(),this._dispose()}get filtered(){if(!this.searchQuery.trim())return[...this.$items.values()];const t=e.toLower(this.searchQuery);return e.filter([...this.$items.values()],i=>e.includes(e.toLower(i.name),t))}isInActiveWorkspace(t){return e.get(Object(h.getStore)("ActiveWorkspaceStore"),"dependencies.environments",[]).includes(t)}get items(){const t=e.filter(this.filtered,e=>this.isInActiveWorkspace(e.id));return e.sortBy(t,t=>t&&[e.toLower(t[this.sortBy]),e.toLower(t.name)])}get activeItemIndex(){return e.findIndex(this.items,e=>e.id===this.activeItem)}setSearchQuery(e){this.searchQuery=e}setSortingKey(t){e.includes(I,t)&&(this.sortBy=t)}focusItem(e){e&&(this.activeItem=e)}resetFocus(){this.activeItem=null}setLoading(e){this.isLoading=e}setSharedEnvironments(e){this.sharedEnvironments=new Set(e)}focusNext(){if(!this.activeItem)return;if(e.isEmpty(this.items))return void this.resetFocus();const t=this.items[(this.activeItemIndex+1)%this.items.length].id;this.focusItem(t),this.openEntityInTabDebounced(t)}focusPrev(){if(!this.activeItem||1===e.size(this.items))return;if(e.isEmpty(this.items))return void this.resetFocus();const t=this.activeItemIndex<=0?e.last(this.items).id:this.items[this.activeItemIndex-1].id;this.focusItem(t),this.openEntityInTabDebounced(t)}openInTab(e){this.openEntityInTabDebounced(e)}getActions(e){const t=this.$items.get(e),i=Object(h.getStore)("ActiveWorkspaceStore").id,r=Object(h.getStore)("PermissionStore"),o=Object(h.getStore)("CurrentUserStore"),{userCanSave:s,userCanSaveAndSync:n}=Object(h.getStore)("OnlineStatusStore");return[{type:A.ACTION_TYPE_SHARE,label:"Share environment",isEnabled:n&&t.userCanShare},{type:A.ACTION_TYPE_RENAME_TOGGLE,label:"Rename",shortcut:"rename",isEnabled:s&&t.userCanUpdate},{type:A.ACTION_TYPE_DUPLICATE,label:"Duplicate",shortcut:"duplicate",isEnabled:s&&r.can("addEnvironment","workspace",i)},{type:A.ACTION_TYPE_FORK,label:"Create a Fork",shortcut:"fork",isEnabled:n},{type:A.ACTION_TYPE_PULL_REQUEST,label:"Create Pull Request",isEnabled:!1},{type:A.ACTION_TYPE_MERGE,label:"Merge changes",isEnabled:!1},{type:A.ACTION_MANAGE_ROLES,label:"Manage Roles",isEnabled:n&&!!o.team},{type:A.ACTION_REMOVE_FROM_WORKSPACE,label:"Remove from workspace",isEnabled:n&&r.can("removeEnvironment","workspace",i)},{type:A.ACTION_TYPE_DELETE,label:"Delete",shortcut:"delete",isEnabled:s&&t.userCanDelete}]}async handleAction(e,t,i={}){const r=this.$items.get(e),o=Object(h.getStore)("PermissionStore"),s=Object(h.getStore)("ActiveWorkspaceStore").id,n=Object(h.getStore)("CurrentUserStore");if(t!==A.ACTION_TYPE_SET_ACTIVE){if(t===A.ACTION_TYPE_SHARE)return Object(h.getStore)("OnlineStatusStore").userCanSaveAndSync?r.userCanShare?void Object(y.shareEnvironment)(e,{origin:"sidebar"}):void pm.toasts.error("You do not have permissions to perform this action"):Object(g.showOfflineActionDisabledToast)();if(t===A.ACTION_TYPE_FORK)return Object(h.getStore)("OnlineStatusStore").userCanSaveAndSync?void Object(E.forkEnvironment)(e,{origin:"sidebar"}):Object(g.showOfflineActionDisabledToast)();if(t!==A.ACTION_TYPE_DUPLICATE){if(t===A.ACTION_TYPE_RENAME)return Object(h.getStore)("OnlineStatusStore").userCanSave?(await Object(E.renameEnvironment)(e,i.name),r.updateName(i.name),pm.mediator.trigger("focusSidebar"),void await Object(E.__forceUpdateNameOnDb)(e,i.name)):Object(g.showOfflineActionDisabledToast)();if(t!==A.ACTION_MANAGE_ROLES){if(t===A.ACTION_REMOVE_FROM_WORKSPACE)return Object(h.getStore)("OnlineStatusStore").userCanSaveAndSync?o.can("removeEnvironment","workspace",s)?void pm.mediator.trigger("showRemoveFromWorkspaceModal",e,{type:"environment",origin:"sidebar",disableDelete:!r.userCanDelete,disableShare:!r.userCanShare},()=>{e===this.activeItem&&this.focusPrev({openEditor:!1}),this.remove(e),Object(E.closeAllEnvironmentTabs)(e)}):void pm.toasts.error("You do not have permissions to perform this action"):Object(g.showOfflineActionDisabledToast)();if(t!==A.ACTION_TYPE_DELETE)pm.logger.warn("EnvironmentSidebarModel~handleAction",`Unhandled action ${t} triggered`);else{if(!Object(h.getStore)("OnlineStatusStore").userCanSave)return Object(g.showOfflineActionDisabledToast)();if(!r.userCanDelete)return void pm.toasts.error("You do not have permissions to perform this action");await Object(E.deleteEnvironment)(e,{name:this.$items.get(e).name})&&(e===this.activeItem&&this.focusPrev({openEditor:!1}),this.remove(e))}}else{if(!Object(h.getStore)("OnlineStatusStore").userCanSaveAndSync)return Object(g.showOfflineActionDisabledToast)();if(!n.team)return;Object(O.manageRolesOnEnvironment)(e,{origin:"sidebar"})}}else{if(!Object(h.getStore)("OnlineStatusStore").userCanSave)return Object(g.showOfflineActionDisabledToast)();const{id:t,name:i}=await Object(E.duplicateEnvironment)(e);this.add({id:t,name:i,attributes:r.attributes})}}else try{r.isActive?await Object(E.setNoActiveEnvironment)():await Object(E.setActiveEnvironment)(e)}catch(e){pm.logger.error("EnvironmentSidebarModel~handleAction",e),pm.toasts.error("There was a error while setting the active environment")}}hydrate(e){e&&e.forEach(e=>{this.$items.set(e.id,new T(e))})}add(e){Array.isArray(e)||(e=[e]),e.forEach(e=>{e&&e.id&&this.$items.set(e.id,new T(e))})}update(e){if(!e||!e.id)return;const t=this.$items.get(e.id);t&&t.update(e)}remove(e){Array.isArray(e)||(e=[e]),e.forEach(e=>this.$items.delete(e))}clear(){this.$items.clear()}}).prototype,"activeItem",[b.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),c=_(n.prototype,"sortBy",[b.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"name"}}),d=_(n.prototype,"searchQuery",[b.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),p=_(n.prototype,"$items",[b.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Map}}),u=_(n.prototype,"isLoading",[b.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),l=_(n.prototype,"sharedEnvironments",[b.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Set}}),_(n.prototype,"filtered",[b.computed],Object.getOwnPropertyDescriptor(n.prototype,"filtered"),n.prototype),_(n.prototype,"items",[b.computed],Object.getOwnPropertyDescriptor(n.prototype,"items"),n.prototype),_(n.prototype,"activeItemIndex",[b.computed],Object.getOwnPropertyDescriptor(n.prototype,"activeItemIndex"),n.prototype),_(n.prototype,"setSearchQuery",[b.action],Object.getOwnPropertyDescriptor(n.prototype,"setSearchQuery"),n.prototype),_(n.prototype,"setSortingKey",[b.action],Object.getOwnPropertyDescriptor(n.prototype,"setSortingKey"),n.prototype),_(n.prototype,"focusItem",[b.action],Object.getOwnPropertyDescriptor(n.prototype,"focusItem"),n.prototype),_(n.prototype,"resetFocus",[b.action],Object.getOwnPropertyDescriptor(n.prototype,"resetFocus"),n.prototype),_(n.prototype,"setLoading",[b.action],Object.getOwnPropertyDescriptor(n.prototype,"setLoading"),n.prototype),_(n.prototype,"setSharedEnvironments",[b.action],Object.getOwnPropertyDescriptor(n.prototype,"setSharedEnvironments"),n.prototype),_(n.prototype,"handleAction",[b.action],Object.getOwnPropertyDescriptor(n.prototype,"handleAction"),n.prototype),_(n.prototype,"hydrate",[b.action],Object.getOwnPropertyDescriptor(n.prototype,"hydrate"),n.prototype),_(n.prototype,"add",[b.action],Object.getOwnPropertyDescriptor(n.prototype,"add"),n.prototype),_(n.prototype,"update",[b.action],Object.getOwnPropertyDescriptor(n.prototype,"update"),n.prototype),_(n.prototype,"remove",[b.action],Object.getOwnPropertyDescriptor(n.prototype,"remove"),n.prototype),_(n.prototype,"clear",[b.action],Object.getOwnPropertyDescriptor(n.prototype,"clear"),n.prototype),n)}.call(this,i(1132))},8473:function(e,t,i){"use strict";i.r(t),function(e){i.d(t,"default",(function(){return p}));var r=i(3450),o=i(3285),s=i(3725),n=i(3771),a=i(8472),c=i(8474),d=i(7437);class p{constructor(){this.model=null,this.adapter=null}async didCreate(){if(this.model=new a.default,this.model.setLoading&&this.model.setLoading(!0),"browser"!==window.SDK_PLATFORM){if(!pm.isScratchpad){const t=await this.fetchEnvironments();!function(t){if(e.isEmpty(t))return;const i=[],r=[];t.forEach(t=>{const o=e.get(t,"attributes.permissions.anybodyCanView"),s=e.get(t,"attributes.permissions.teamCanView");o&&i.push({id:t.id}),s&&r.push({id:t.id})}),!e.isEmpty(i)&&Object(o.getStore)("PublicEntityStore").add(i),!e.isEmpty(r)&&Object(o.getStore)("SharedEnvironmentsStore").add(r)}(e.get(t,"body.data",[]))}this.adapter=new d.default(this.model)}else this.adapter=new c.default(this.model);await this.adapter.hydrate(),this.model.setLoading&&this.model.setLoading(!1)}async fetchEnvironments(){await Object(o.getStore)("SyncStatusStore").onSyncAvailable();const t=Object(o.getStore)("ActiveWorkspaceStore").id,i=await r.default.request(n.ENVIRONMENT_LIST_AND_SUBSCRIBE`${t}`,{method:"POST"}),a=e.forEach(e.get(i,"body.data",[]),t=>{const i={model:"environment",modelId:t.id,action:"UPDATE_ENVIRONMENT"},r=s.default.getCompositeKey(i);!Object(o.getStore)("PermissionStore").members.has(r)&&e.set(t,"attributes.permissions.userCanUpdate",!0)});return this.model.hydrate&&this.model.hydrate(a),this.model.setLoading&&this.model.setLoading(!1),i}beforeDestroy(){this.model.dispose(),this.model=null,this.adapter&&this.adapter.dispose(),this.adapter=null}}}.call(this,i(1132))},8474:function(e,t,i){"use strict";i.r(t),i.d(t,"default",(function(){return n}));var r=i(3285),o=i(8453),s=i(3771);class n extends o.default{getListAndSubscribeAPIEndpoint(){const e=Object(r.getStore)("ActiveWorkspaceStore").id;return s.ENVIRONMENT_LIST_AND_SUBSCRIBE`${e}`}getListAPIEndpoint(){const e=Object(r.getStore)("ActiveWorkspaceStore").id;return s.ENVIRONMENT_LIST`${e}`}}}}]);
//# sourceMappingURL=EnvironmentSidebarController-c26b34d6ba43f21e6c0f.min.js.map