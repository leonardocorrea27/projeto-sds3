(window.webpackJsonp=window.webpackJsonp||[]).push([[32],{8451:function(e,t,i){"use strict";i.r(t),function(e){i.d(t,"default",(function(){return v}));var s,r,o=i(1505),n=i(3285),a=i(3725),l=i(3280),c=i.n(l),d=i(6556),u=i(4224),b=i(4220),h=i(7446),p=i(7453),m=i(8452),g=i(4772),S=i(3751),E=i(3771);function f(e,t,i,s,r){var o={};return Object.keys(s).forEach((function(e){o[e]=s[e]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=i.slice().reverse().reduce((function(i,s){return s(e,t,i)||i}),o),r&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(r):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(e,t,o),o=null),o}let v=(r=f((s=class{constructor(){var e,t,i,s;this.model=null,this._adapters=[],e=this,t="status",s=this,(i=r)&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(s):void 0})}async didCreate(){if(this.model=new d.default,"browser"===window.SDK_PLATFORM){try{await this._loadFromListingAPIAdapter(),await this._loadExtensibleCollections()}catch(e){return pm.logger.error("CollectionSidebarController~didCreate: Error in loading collection list from listing API",e),this.setSidebarStatus(g.ERROR)}return this.setSidebarStatus(g.READY)}try{await this._loadFromListingAPI(),await this._loadExtensibleCollections(),this.setSidebarStatus(g.READY)}catch(e){pm.logger.error("CollectionSidebarController~didCreate: Failed to fetch collection list:",e)}try{await this._loadFromModelEventsAdapter()}catch(e){return pm.logger.error("CollectionSidebarController~didCreate: Error in loading collections from model events",e),this.setSidebarStatus(g.ERROR)}return this.setSidebarStatus(g.READY)}beforeDestroy(){this._adapters&&this._adapters.forEach(t=>{e.isFunction(t.dispose)&&t.dispose()}),this.extensibleCollectionChangeListenersDisposer&&this.extensibleCollectionChangeListenersDisposer(),this.model=null,this._adapters=[]}setSidebarStatus(e){this.status=e}async _fetchCollections(){await Object(n.getStore)("SyncStatusStore").onSyncAvailable();const t=Object(n.getStore)("ActiveWorkspaceStore").id,i=await S.RemoteSyncRequestService.request(E.COLLECTION_LIST`${t}`,{method:"POST",timeout:3e4}),s=e.forEach(e.get(i,"body.data",[]),t=>{const i={model:"collection",modelId:t.id,action:"UPDATE_COLLECTION"},s=a.default.getCompositeKey(i);!Object(n.getStore)("PermissionStore").members.has(s)&&e.set(t,"attributes.permissions.userCanUpdate",!0)});return this.model.hydrate&&this.model.hydrate(s),s}async _loadExtensibleCollections(){let e;try{e=await c.a.list()}catch(e){pm.logger.error("CollectionSidebarController~_loadExtensibleCollections",e)}this.model.hydrateExtensibleCollection(e),this.extensibleCollectionChangeListenersDisposer=c.a.cacheAPI.subscribeToChanges(this.model.getExtensibleCollectionEventListeners())}async _loadFromListingAPI(){if(pm.isScratchpad)return;!function(t){if(e.isEmpty(t))return;const i=[],s=[],r=[],o=[];t.forEach(t=>{const n=e.get(t,"attributes.flags.isFavorite"),a=e.get(t,"attributes.permissions.teamCanView"),l=e.get(t,"attributes.permissions.anybodyCanView"),c=e.get(t,"attributes.flags.isArchived"),d=Object(S.decomposeUID)(t.id).modelId,u={id:d};n&&i.push(u),a&&s.push(u),l&&r.push({id:t.id}),c&&o.push({model:"collection",modelId:d})}),!e.isEmpty(i)&&Object(n.getStore)("FavoritedCollectionStore").add(i),!e.isEmpty(s)&&Object(n.getStore)("SharedCollectionsStore").add(s),!e.isEmpty(r)&&Object(n.getStore)("PublicEntityStore").add(r),!e.isEmpty(o)&&Object(n.getStore)("ArchivedResourceStore").add(o)}(await this._fetchCollections())}async _loadFromModelEventsAdapter(){const e=Object(n.getStore)("ActiveWorkspaceStore").id,t=new u.default(this.model.getCollectionAdapterModel(),{activeWorkspace:e,useUID:!0}),i=new b.default(this.model.getFolderAdapterModel()),s=new h.default(this.model.getRequestAdapterModel()),r=[t.hydrate(),i.hydrate(),s.hydrate()];this._adapters.push(t,i,s),await Promise.all(r),this.setSidebarStatus(g.READY);const o=new p.default(this.model.getResponseAdapterModel());this._adapters.push(o),await o.hydrate()}async _loadFromListingAPIAdapter(){const e=new m.default(this.model.getCollectionAdapterModel());this._adapters.push(e),await e.hydrate()}}).prototype,"status",[o.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return g.LOADING}}),f(s.prototype,"setSidebarStatus",[o.action],Object.getOwnPropertyDescriptor(s.prototype,"setSidebarStatus"),s.prototype),s)}.call(this,i(1132))},8452:function(e,t,i){"use strict";i.r(t),function(e){i.d(t,"default",(function(){return l}));var s=i(3285),r=i(3295),o=i(3300),n=i(3771),a=i(8453);class l extends a.default{getListAndSubscribeAPIEndpoint(){const e=Object(s.getStore)("ActiveWorkspaceStore").id;return n.COLLECTION_LIST_AND_SUBSCRIBE`${e}`}getListAPIEndpoint(){const e=Object(s.getStore)("ActiveWorkspaceStore").id;return n.COLLECTION_LIST`${e}`}dispose(){super.dispose(),this.unsubscribeModelEvents&&this.unsubscribeModelEvents()}_subscribeToChangeEvents(t){super._subscribeToChangeEvents(t),this.unsubscribeModelEvents&&this.unsubscribeModelEvents(),this.unsubscribeModelEvents=null,this.unsubscribeModelEvents=pm.eventBus.channel("model-events").subscribe(t=>{if("collection"!==Object(r.getEventNamespace)(t))return;const i=Object(r.getEventName)(t);if(!["favorite","unfavorite"].includes(i))return;const s=Object(r.getEventData)(t),n=e.get(s,"collection.id"),a=e.get(s,"collection.owner"),l=Object(o.composeUID)(n,a),c="favorite"===i;this.model.updateFavorite&&this.model.updateFavorite(l,c)})}}}.call(this,i(1132))},8453:function(e,t,i){"use strict";i.r(t),function(e){i.d(t,"default",(function(){return l}));var s=i(3497),r=i(3450),o=i(8454),n=i(3285),a=i(4222);class l extends a.default{getListAndSubscribeAPIEndpoint(){throw new Error(this.constructor.name+"~getListAndSubscribeAPIEndpoint: not implemented")}getListAPIEndpoint(){throw new Error(this.constructor.name+"~getListAPIEndpoint: not implemented")}hydrate(t=!0){return new Promise((i,r)=>{this._connection_subscription=Object(s.getSocketConnectionObservable)().subscribe(s=>{if("connect"===s)return this._getAPIResponse().then(i=>{const s=e.get(i,"body.data",[]),r=e.get(i,"body.subscription.id");this._hydrateEntities(s),t&&r&&this._subscribeToChangeEvents(r)}).then(()=>i()).catch(e=>(pm.logger.warn("ListingAPIAdapter~hydrate: Failed to hydrate entities",e),r(e)))})})}dispose(){super.dispose(),this._connection_subscription&&this._connection_subscription.unsubscribe(),this._realtime_subscription&&this._realtime_subscription.unsubscribe()}_hydrateEntities(e){this.model.hydrate&&this.model.hydrate(e)}_removeEntities(t){e.isEmpty(t)||this.model.remove&&this.model.remove(t)}_addEntities(t){e.isEmpty(t)||this.model.add&&this.model.add(t)}async _getAPIResponse(){return await Object(n.getStore)("SyncStatusStore").onSyncAvailable(),r.default.request(this.getListAndSubscribeAPIEndpoint(),{method:"POST",timeout:3e4})}_subscribeToChangeEvents(t){this._realtime_subscription&&this._realtime_subscription.unsubscribe(),this._realtime_subscription=Object(o.realtimeEventsForSubscription)(t).subscribe(t=>{const i=e.get(t,"data.data",[]),s=i.filter(({action:e})=>["create","update"].includes(e)).map(({id:e})=>e),r=i.filter(({action:e})=>"delete"===e).map(({id:e})=>e);this._removeEntities(r),this._createOrUpdateEntities(s)})}async _createOrUpdateEntities(t){if(e.isEmpty(t))return;await Object(n.getStore)("SyncStatusStore").onSyncAvailable();const i=await r.default.request(this.getListAPIEndpoint(),{method:"POST",data:{ids:t},timeout:3e4}),s=e.get(i,"body.data",[]);this._addEntities(s)}}}.call(this,i(1132))},8454:function(e,t,i){"use strict";i.r(t),function(e){i.d(t,"realtimeEventsForSubscription",(function(){return o}));var s=i(3527),r=i(3629);function o(t){return Object(r.getRealtimeMessagesObservable)().pipe(Object(s.filter)(i=>e.get(i,"data.subscription.id")===t))}}.call(this,i(1132))}}]);
//# sourceMappingURL=CollectionSidebarController-6437cc9bb021ec55982b.min.js.map